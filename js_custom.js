// ==UserScript==
// @name         jira-custom-modification
// @namespace    http://tampermonkey.net/
// @version      0.4.45
// @description  add some additional features for JIRA
// @author       T. Hinze
// @match        https://positivmultimedia.atlassian.net/*
// @grant        none
// @update       https://raw.githubusercontent.com/thinze/jira-custom-modification/master/js_custom.js?v=0.4.45
// ==/UserScript==
!function(){"use strict";var a,e,c="0.4.45",o=1,r=["erledigt","geschlossen"],i={},n={colored_tasks:{type:"bool",label:"Tasks färben",val:1},warn_ups:{type:"bool",label:"markiere Service-Proj.",val:0},color_ups_fg:{type:"color",label:"Service-Proj. Schriftfarbe",val:"#333333"},color_ups_bg:{type:"color",label:"Service-Proj. Background",val:"#ffff00"},color_day2:{type:"color",label:"in 2 Tagen",val:"#00bfff"},color_day1:{type:"color",label:"in 1 Tagen",val:"#ff9900"},color_day0:{type:"color",label:"heute",val:"#cc33ff"},color_over:{type:"color",label:"überlaufen",val:"#ff0000"},old_issue_view:{type:"bool",label:"alte Task-Ansicht",val:1},show_projectname:{type:"bool",label:"zeige Projektname",val:0},quick_search:{type:"bool",label:"Schnellsuche",val:1},quick_actions:{type:"bool",label:"Quick-Actions",val:1},version:{type:"readonly",label:"Version",val:"?"}},l=new MutationObserver(function(e){e.forEach(function(e){"style"==e.attributeName&&N()})}),s='<button id="my-jira-cfg-btn">+</button><div id="my-jira-cfg-settings"><nav id="my-jira-cfg-menu"><span id="goto-my-jira-cfg-dashbaord" class=" active">Dashboard</span><span id="goto-my-jira-cfg-tasks">Tasks</span><span id="goto-my-jira-cfg-misc">Misc</span></nav><fieldset id="my-jira-cfg-dashbaord" class="cfg-section active"><div class="inner"><h3>Dashboard-Setting</h3></div></fieldset><fieldset id="my-jira-cfg-tasks" class="cfg-section"><div class="inner"><h3>Tasks Settings</h3></div></fieldset><fieldset id="my-jira-cfg-misc" class="cfg-section"><div class="inner"><h3>Misc Settings</h3></div><button id="my-jira-cfg-help">Help</button></fieldset></div>',d='<div class="jira-page-loading-indicator my-jira-spiner"></div>',t="#page-body .my-jira-logobox { padding-top: 85px; } #my-jira-quick-actions { position:fixed; background:rgba(0, 0, 0, 0.65); padding:5px; z-index:99999; top:5px; left:64px;   /* transform:translate(-50%, 0); */ }#my-jira-quick-actions.hide { display: none; }#my-jira-dashboard-actions { }#my-jira-dashboard-actions h6 { color: #ccc; margin: -5px 0 5px; padding: 0; } #my-jira-dashboard-actions .row {}#my-jira-dashboard-actions .row button { font-size:90%; margin:1px; }#my-jira-dashboard-actions .row button:hover { background:green; color:#fff; }#my-jira-dashboard-actions .row button:active { background:black; } #my-jira-cfg-dialog { position: fixed; top: 0; z-index: 9999; } #my-jira-cfg-btn { width: 24px; height: 24px; background: #444; color: #ccc; margin: 1px; } #my-jira-cfg-btn:hover { background: #999; color: #fff; } #my-jira-cfg-btn.open { background: lightgreen; color: #fff; width: 24px; height: 24px; } #my-jira-cfg-settings { background: #444; border: 1px solid #ccc; display: none; position: relative; padding-left: 100px; } #my-jira-cfg-settings.open { display: block; } #my-jira-cfg-menu { background: #666; width: 100px; position: absolute; top: 0; left: 0; border-right: 1px solid #999; height: 100%; } #my-jira-cfg-menu span { color: #fff; display: block; padding: 4px 2px; margin: 0 0 5px; border-bottom: 1px solid #aaa; } #my-jira-cfg-menu span.active, #my-jira-cfg-menu span:hover { background: #ccc; color: #000; cursor: pointer; } #my-jira-cfg-menu #my-jira-cfg-save { background: #aaa; color: #000; cursor: pointer; position: absolute; bottom: 0; left: 0; width: 100%; } #my-jira-cfg-menu #my-jira-cfg-save:hover { background: #ccc; color: #333; cursor: pointer; } #my-jira-cfg-menu #my-jira-cfg-save.saved { background: lightgreen; color: #fff; } #my-jira-cfg-settings fieldset { display: none; min-width: 200px; min-height: 160px; color: #ccc; } #my-jira-cfg-settings fieldset.active { display: block; } #my-jira-cfg-settings fieldset .inner { padding: 3px 5px; } #my-jira-cfg-settings fieldset .inner h3 { color: #ccc; font-size: 110%; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 5px; } #my-jira-cfg-settings fieldset .opt-row { margin: 0 0 5px; } #my-jira-cfg-settings fieldset .opt-row label { display: inline-block; width: 100px; } #my-jira-cfg-settings fieldset .opt-row input.color { display: inline-block; width: 30px; height: 20px; background: transparent; } #my-jira-cfg-settings fieldset .opt-row input.bool { display: inline-block; width: 16px; } #my-jira-cfg-settings fieldset .opt-row input.text { display: inline-block; width: 80px; } #my-jira-cfg-help { margin: 0 auto; width: 90%; display: block; } #my-jira-cfg-help:hover {  background: #999; color: #fff; } #issuetype-single-select, div#project-single-select { max-width: none; width: 600px; } #issuetype-single-select > input, div#project-single-select > input { max-width: none; } #content #project_container .aui-ss-field#project-field { max-width: none !important; width: 600px; background: red; } #quick-search-field { display: inline-block; position: fixed; z-index: 99999; top: 65px; left: 64px; /* transform:translateX(-50%); */         width: 235px; max-width: none; background: #eee; padding: 2px; } #quick-search-field.filtering { background: lightgreen; } #quick-search-clear { display: inline-block; position: fixed; width: 235px; max-width: none; top: 65px; left: 64px; /* transform: translateX(-50%); */         height: 1em; background: darkred; margin-left: 1em; z-index: 99998; padding: 3px; } #quick-search-clear:hover { cursor: pointer; } #issuetable tr.tr-off, .gadget tr.tr-off { display: none !important; } ";function u(e){if(o){var t=new Date,a=[t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()].join(":");console.log(a+": "+e)}}function f(e){return e=(e=e.trim()).replace("Mär","Mar").replace("Mai","May").replace("Okt","Oct").replace("Dez","Dec"),new Date(e)}function m(e,t){var a=document.createElement("STYLE");t&&(a.id=t),a.innerHTML=e,document.querySelector("head").appendChild(a)}function p(e,t){var a=document.querySelector("#"+t);a&&a.parentNode.removeChild(a),m(e,t)}function g(e,t){Object.assign(e.style,t)}function y(){g(document.querySelector("#page-body"),{width:"0px",minWidth:"inherit"}),window.setTimeout(function(){g(document.querySelector("#page-body"),{width:"auto",minWidth:"fit-content"})},1)}function h(e){var t=!1;return"object"==typeof e&&(localStorage.setItem("my-jira-cfg",JSON.stringify(e)),t=!0,u("cfg saved")),t}function b(){var e,t=document.querySelector("#navigation-app"),a=document.createElement("DIV");(a.id="my-jira-cfg-dialog",a.innerHTML=s.trim(),t)&&(t.appendChild(a),document.querySelector("#my-jira-cfg-btn").addEventListener("click",v),document.querySelectorAll("#my-jira-cfg-menu span").forEach(function(e){e.addEventListener("click",k)}),document.querySelector("#my-jira-cfg-settings")&&((e=document.querySelector("#my-jira-cfg-dashbaord .inner"))&&(w("quick_actions",e),w("quick_search",e),w("warn_ups",e),w("color_ups_fg",e),w("color_ups_bg",e)),(e=document.querySelector("#my-jira-cfg-tasks .inner"))&&(w("colored_tasks",e),w("color_over",e),w("color_day0",e),w("color_day1",e),w("color_day2",e),w("old_issue_view",e),w("show_projectname",e)),(e=document.querySelector("#my-jira-cfg-misc .inner"))&&(document.querySelector("#my-jira-cfg-help").addEventListener("click",function(){var e;e="https://github.com/thinze/jira-custom-modification/blob/master/HELP.md",window.open(e,"_blank").focus()}),w("version",e))),function(){if(document.querySelector("#my-jira-cfg-settings"))for(var e in n){var t=document.querySelector("#cfg-"+e);if(t)switch(t.dataset.cfg_type){case"bool":i[e]?t.checked="checked":t.checked="";break;case"color":i[e]?t.value=i[e]:t.value=""}}}())}function v(){var e=document.querySelector("#my-jira-cfg-settings");-1==e.className.indexOf(" open")?(e.className+=" open",q()):(e.className=e.className.replace(" open",""),S())}function k(e){var t=e.target;document.querySelectorAll("#my-jira-cfg-menu span").forEach(function(e){e.className=e.className.replace(" active","")}),t.className+=" active",document.querySelectorAll("#my-jira-cfg-settings fieldset").forEach(function(e){e.className=e.className.replace(" active","")}),document.querySelector("#"+t.id.replace("goto-","")).className+=" active"}function w(e,t){if(t&&n.hasOwnProperty(e)){var a=document.createElement("LABEL"),o=document.createElement("INPUT");switch(a.htmlFor=e,a.innerHTML=n[e].label,o.id="cfg-"+e,n[e].type){case"bool":o.type="checkbox",o.className="bool",o.dataset.cfg_type="bool";break;case"color":o.type="color",o.className="color",o.dataset.cfg_type="color";break;case"text":o.type="text",o.className="text",o.dataset.cfg_type="text";break;case"readonly":(o=document.createElement("SPAN")).className="field-readonly",o.innerText=c}o.addEventListener("change",x);var r=document.createElement("DIV");r.className="opt-row",r.appendChild(a),r.appendChild(o),t.appendChild(r)}}function x(e){var t,a=e.target;if(a){switch(a.dataset.cfg_type){case"bool":t=a.checked?1:0,i[a.id.replace("cfg-","")]=t;break;case"color":case"text":i[a.id.replace("cfg-","")]=a.value}h(i)}}function j(){document.querySelector(".css-79elbk")&&(window.clearInterval(e),function(){var e=document.createElement("DIV");e.id="my-jira-quick-actions",document.querySelector("body").appendChild(e);var t=document.querySelector(".css-cm9zc8");t.className+=" my-jira-logobox",function(){if(i&&i.quick_actions){var e=document.querySelector("#dashboard-content");if(e){var t=document.createElement("DIV");t.id="my-jira-dashboard-actions",t.innerHTML='<h6>Actions</h6><div class="row"><button id="widgets-collapse" data-callback="widgetsCollapseAll" class="action">collapse</button><button id="widgets-expand" data-callback="widgetsExpandAll" class="action">expand</button></div>'.trim(),document.querySelector("#my-jira-quick-actions").appendChild(t),document.querySelector("#my-jira-dashboard-actions #widgets-collapse").addEventListener("click",E),document.querySelector("#my-jira-dashboard-actions #widgets-expand").addEventListener("click",L)}}}(),function(){if(i&&i.quick_search){var e=document.querySelector("#my-jira-quick-actions"),t=document.querySelector("#dashboard-content"),a=document.querySelector("#content .navigator-body");if(e&&(t||a)){var o=document.createElement("INPUT"),r=document.createElement("SPAN");o.id="quick-search-field",r.id="quick-search-clear",e.appendChild(o),e.appendChild(r),N(),o.addEventListener("keyup",function(e){var t=e.target,r=t.value.toLowerCase();if(r&&3<=r.length){t.className=t.className.replace(" filtering","")+" filtering",L();var a=document.querySelectorAll("div.gadget, #issuetable");a.forEach(function(e){var t=e.querySelectorAll("tbody tr");if(t.forEach(function(e){-1==e.innerText.toLowerCase().indexOf(r)?e.className=e.className.replace("tr-off","")+" tr-off":e.className=e.className.replace("tr-off","")}),"DIV"==e.tagName){var a=e.querySelector("div.results-wrap"),o=e.querySelector(".gadget-inline");a&&(-1==e.className.indexOf(" resized")&&(e.dataset.origHeight=o.style.height,e.clsssName+=" resized"),o.style.height=a.style.height)}}),y()}else{t.className=t.className.replace(" filtering",""),document.querySelectorAll(".gadget tr.tr-off, #issuetable tr.tr-off").forEach(function(e){e.className=e.className.replace("tr-off","")}),y()}}),r.addEventListener("click",function(e){var t=document.querySelector("#quick-search-field");t.value="",t.className=t.className.replace(" filtering",""),document.querySelectorAll(".gadget tr.tr-off, #issuetable tr.tr-off").forEach(function(e){e.className=e.className.replace("tr-off","")}),y()})}}}();var a=document.querySelector("button.css-qm60v3");a&&a.addEventListener("click",_);var o=document.querySelector("#quickSearchGlobalItem");o&&o.addEventListener("click",function(){q(),window.setTimeout(function(){var e=document.querySelector("button[data-test-selector='DrawerPrimitiveSidebarCloseButton']");e&&e.addEventListener("click",S)},500)});l.observe(t.parentNode,{attributes:!0,childList:!0,characterData:!0})}())}function q(){var e=document.querySelector("#my-jira-quick-actions");e&&(e.className=e.className.replace(" hide","")+" hide")}function S(){var e=document.querySelector("#my-jira-quick-actions");e&&(e.className=e.className.replace(" hide",""))}function N(e){var t=document.querySelector("#my-jira-quick-actions"),a=document.querySelector(".css-cm9zc8").parentNode,o=document.querySelector("#quick-search-field"),r=document.querySelector("#quick-search-clear");if(t&&o&&r){S();var c=a.offsetWidth-20;c<140?q():(o.style.width=c+"px",r.style.width=c+"px")}}function _(){var e=document.querySelector("#my-jira-quick-actions");if(e){document.querySelector(".css-cm9zc8");document.querySelector(".css-1ufv8rh .css-1sjc3tg")?(u("sidebar is open"),-1==e.className.indexOf("hide")?e.className=e.className.replace(" hide","")+" hide":e.className=e.className.replace(" hide","")):(u("sidebar is closed"),e.className=e.className.replace(" hide","")+" hide")}}function E(){document.querySelectorAll(".dashboard-item-content").forEach(function(e,t){-1==e.className.indexOf(" minimization")&&(e.className=e.className+" minimization",e.previousSibling.querySelector(".dashboard-item-title").dispatchEvent(new Event("dblclick")))})}function L(){document.querySelectorAll(".dashboard-item-content.minimization").forEach(function(e,t){e.className=e.className.replace(" minimization",""),e.previousSibling.querySelector(".dashboard-item-title").dispatchEvent(new Event("dblclick"))}),y()}function T(e){var t=864e5,a=(new Date).toDateString().split(" "),o=new Date([a[2],a[1],a[3]].join("/")),r=new Date(e)-o,c="";return r<0?c=" overrun":r<t?c=" todo-days-0":t<=r&&r<1728e5?c=" todo-days-1":1728e5<=r&&r<2592e5&&(c=" todo-days-2"),c}function A(){if(i&&i.old_issue_view){var e=document.querySelector("#jira-frontend-content .gGZyaD a[href*='?oldIssueView=true']");if(e&&(window.clearInterval(a),window.stop(),!document.querySelector("#wait-for-loading"))){var t=document.createElement("DIV");t.id="wait-for-loading",t.innerHTML=d.trim(),document.querySelector("body").append(t),e.click()}}}function D(){-1!==location.href.indexOf("/Dashboard.jspa")&&(document.querySelector("#dashboard-content .dashboard-shim")||(u("reload page"),location.href=location.href)),m(t),function(){var t;try{if(null===(t=JSON.parse(localStorage.getItem("my-jira-cfg"))))throw"cfg loading error";for(var a in u("cfg loaded"),n)t.hasOwnProperty(a)||(t[a]=n[a].val,u("add config option : "+a));u("cfg checked")}catch(e){for(var a in t={},n)t[a]=n[a].val;u("cfg loading failed - use default settings")}h(i=t)}(),b(),a=window.setInterval(A,100),e=window.setInterval(j,100),function(){if(i&&i.old_issue_view){var e=document.querySelectorAll("a.issue-link");e.length&&e.forEach(function(e){-1==e.href.indexOf("oldIssueView=true")&&(-1==e.href.indexOf("?")?e.href+="?oldIssueView=true":e.href+="&oldIssueView=true")})}}(),function(){if(i&&i.colored_tasks){p(".overrun td, .overrun td a { color: "+i.color_over+"!important; } .todo-days-0 td, .todo-days-0 td a { color: "+i.color_day0+" !important; } .todo-days-1 td, .todo-days-1 td a { color: "+i.color_day1+" !important; } .todo-days-2 td, .todo-days-2 td a { color: "+i.color_day2+" !important; } .overrun > time { background-color: "+i.color_over+" !important; color: #fff !important; padding: 2px 5px; } .todo-days-0 > time { background-color: "+i.color_day0+" !important; color: #fff !important; padding: 2px 5px; } .todo-days-1 > time { background-color: "+i.color_day1+" !important; color: #fff !important; padding: 2px 5px; } .todo-days-2 > time { background-color: "+i.color_day2+" !important; color: #fff !important; padding: 2px 5px; } ","colored-tasks"),document.querySelectorAll("td.duedate").forEach(function(e){var t=e.parentNode.querySelector("td.status");if(t=t?t.innerText.toLowerCase():"offen",-1==r.indexOf(t)){var a=T(f(e.innerText));e.closest("tr").className+=a}});var e=document.querySelector(".issue-view #due-date");if(e){var t=T(f(e.innerText));e.className+=t}}}(),function(){if(i&&i.warn_ups){p(".project.special { background-color: "+i.color_ups_bg+" !important; color: "+i.color_ups_fg+" !important; } .project.special a { color: "+i.color_ups_fg+" !important; } ","ups-styles");var e=document.querySelectorAll("td.project a");if(e.length)for(var t=0;t<e.length;t++){var a=e[t];(a.innerText.endsWith("Support Service")||a.innerText.endsWith("Support Service"))&&(a.parentNode.className=a.parentNode.className.replace(" special","")+" special")}}}(),function(){if(i&&i.show_projectname){var e=document.querySelector(".css-6p2euf");if(e){var t=document.querySelector(".aui-nav-breadcrumbs");t&&t.prepend(e.innerText+" : ")}}}()}window.addEventListener("load",function e(t){window.removeEventListener("load",e),window.setTimeout(D,500)},!1,!0)}();